<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111111">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Star Wars Animated & Spinoffs Timeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xxs': '360px',
                        'xs': '480px',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #f0f0f0;
            background-image: url('https://images.unsplash.com/photo-1506318137071-a8e063b4bec0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3540&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
            -webkit-text-size-adjust: 100%;
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        /* Custom checkbox style */
        .custom-checkbox {
            -webkit-appearance: none;
            appearance: none;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.1em;
            height: 1.1em;
            border: 0.1em solid currentColor;
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.8em;
            height: 0.8em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #3498db; /* Light Blue */
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }
        .custom-checkbox:checked {
            background-color: rgba(52, 152, 219, 0.2);
            border-color: #3498db; /* Light Blue */
        }
        .custom-checkbox:focus {
            outline: max(2px, 0.15em) solid #3498db; /* Light Blue */
            outline-offset: max(2px, 0.15em);
        }

        /* Animation for timeline items */
        .timeline-item {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .timeline-item.is-visible {
            opacity: 1;
            transform: scale(1);
        }
        
        /* Watched state styling */
        .watched .series-card {
            opacity: 0.6;
            border-left-color: #3498db; /* Light Blue */
        }
        .watched .series-title {
            text-decoration: line-through;
            text-decoration-color: #3498db; /* Light Blue */
            text-decoration-thickness: 2px;
        }
        .watched .series-card img {
            filter: grayscale(80%) brightness(0.7);
        }
        
        /* Star field animation */
        .star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation-name: twinkle;
            animation-duration: 4s;
            animation-iteration-count: infinite;
            z-index: -1;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .text-2xs {
            font-size: 0.65rem;
            line-height: 1rem;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-2 xs:px-4 py-6 md:py-12">
        <header class="text-center mb-6 md:mb-10">
            <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-white">
                Star Wars Animated & Spinoffs
            </h1>
            <p class="mt-2 md:mt-3 text-sm md:text-lg text-gray-400 max-w-3xl mx-auto">
                An interactive timeline to track your watch progress.
            </p>
             <div class="flex justify-center items-center mt-3 md:mt-4 space-x-2">
                <button id="export-progress" class="bg-blue-800 hover:bg-blue-700 text-white text-xs md:text-sm py-1 px-2 md:px-3 rounded">
                    Save Progress
                </button>
                <button id="import-progress" class="bg-gray-700 hover:bg-gray-600 text-white text-xs md:text-sm py-1 px-2 md:px-3 rounded">
                    Load Progress
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden">
            </div>
            <div class="mt-4">
    <a href="index.html" class="inline-block bg-gray-800 hover:bg-gray-700 text-blue-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
        &larr; Back to Hub
    </a>
</div>
        </header>

        <div id="timeline-container" class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4 max-w-7xl mx-auto">
            </div>
        
        <div class="fixed bottom-4 right-4 opacity-10 w-28 md:w-36 pointer-events-none">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/Star_Wars_Logo.svg/1200px-Star_Wars_Logo.svg.png" alt="Star Wars Logo" class="w-full">
        </div>
    </div>
    
    <div id="status-notification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 text-sm z-50 flex items-center space-x-2 pointer-events-none">
        </div>
    
    <div id="offline-indicator" class="fixed top-2 right-2 bg-yellow-600 text-black py-1 px-3 rounded-lg text-xs hidden flex items-center z-50">
        <span class="mr-1">●</span>
        <span>Offline Mode</span>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
        <div class="relative max-w-4xl w-full">
            <button id="closeModal" class="absolute -top-12 right-0 text-white text-2xl cursor-pointer">&times; Close</button>
            <div class="bg-gray-900 rounded-lg overflow-hidden">
                <img id="modalImage" src="" alt="Full size image" class="w-full h-auto max-h-[70vh] object-contain">
                <div class="p-6">
                    <h3 id="modalTitle" class="text-2xl text-blue-400 font-bold mb-2"></h3>
                    <p id="modalDescription" class="text-gray-300"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Create star field background
        function createStars() {
            const starCount = 100;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}vw`;
                star.style.top = `${Math.random() * 100}vh`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                document.body.appendChild(star);
            }
        }
        
        // Series data with local image paths in the correct order
        const seriesData = [
            { title: "Star Wars Holiday Special", season: "TV Special", date: "Nov 17, 1978", image: "images/Star Wars Holiday Special - TV Special.png", description: "The infamous variety show featuring Chewbacca's family and musical performances." },
            { title: "The Ewok Adventure", season: "TV Film", date: "Nov 25, 1984", image: "images/The Ewok Adventure - TV Film.png", description: "The Towani family is stranded on Endor and needs the help of the Ewoks to find their parents." },
            { title: "Droids", season: "1 Season", date: "Sep 1985 - Jun 1986", image: "images/Droids - 1 Season.png", description: "The adventures of R2-D2 and C-3PO before they joined the Rebellion." },
            { title: "Ewoks", season: "2 Seasons", date: "Sep 1985 - Dec 1986", image: "images/Ewoks - 2 Seasons.png", description: "Follow the adventures of Wicket and his friends on the forest moon of Endor." },
            { title: "Ewoks The Battle for Endor", season: "TV Film", date: "Nov 24, 1985", image: "images/Ewoks The Battle for Endor - TV Film.png", description: "Cindel and the Ewoks must fight against evil marauders who have taken over Endor." },
            { title: "Clone Wars (2D Micro-Series)", season: "3 Seasons", date: "Nov 2003 - Mar 2005", image: "images/Clone Wars (2D Micro-Series) - 3 Seasons.png", description: "Genndy Tartakovsky's stylized take on the Clone Wars." },
            { title: "The Clone Wars", season: "Animated Film", date: "2008", image: "images/The Clone Wars - Animated Film.png", description: "Anakin and his new Padawan Ahsoka must rescue Jabba the Hutt's son." },
            { title: "The Clone Wars (Animated Series)", season: "7 Seasons", date: "Oct 2008 - May 2020", image: "images/The Clone Wars (Animated Series) - 7 Seasons.png", description: "The epic saga of the Clone Wars featuring Anakin, Obi-Wan, and Ahsoka." },
            { title: "Rebels", season: "4 Seasons", date: "Oct 2014 - Mar 2018", image: "images/Rebels - 4 Seasons.png", description: "The crew of the Ghost fights against the Empire in the early days of the Rebellion." },
            { title: "Blips", season: "1 Season", date: "May - Sep 2017", image: "images/Blips - 1 Season.png", description: "Short adventures featuring BB-8 and other droids from the sequel trilogy." },
            { title: "Forces of Destiny", season: "2 Seasons", date: "Jul 2017 - May 2018", image: "images/Forces of Destiny - 2 Seasons.png", description: "Short stories focusing on the heroines of Star Wars." },
            { title: "Resistance", season: "2 Seasons", date: "Oct 2018 - Jan 2020", image: "images/Resistance - 2 Seasons.png", description: "Kazuda Xiono becomes a spy for the Resistance against the First Order." },
            { title: "Galaxy of Adventures", season: "2 Seasons", date: "Nov 2018 - Oct 2020", image: "images/Galaxy of Adventures - 2 Seasons.png", description: "Reimagined classic Star Wars moments in a modern animation style." },
            { title: "Roll Out", season: "1 Season", date: "Aug 2019 - Apr 2020", image: "images/Roll Out - 1 Season.png", description: "Cute, spherical versions of Star Wars characters have mini-adventures." },
            { title: "The Bad Batch", season: "3 Seasons", date: "May 2021 - May 2024", image: "images/The Bad Batch - 3 Seasons.png", description: "Elite clone troopers with genetic mutations navigate the early Imperial era." },
            { title: "Visions", season: "2 Seasons", date: "Sep 2021 - Ongoing", image: "images/Visions - 2 Seasons.png", description: "Anime-inspired anthology series with unique takes on the Star Wars universe." },
            { title: "Galaxy of Creatures", season: "2 Seasons", date: "Oct 2021 - Feb 2023", image: "images/Galaxy of Creatures - 2 Seasons.png", description: "A droid explores and documents various creatures throughout the galaxy." },
            { title: "Galactic Pals", season: "1 Season", date: "Apr - Nov 2022", image: "images/Galactic Pals - 1 Season.png", description: "A caretaker droid looking after baby versions of Star Wars aliens." },
            { title: "Tales", season: "3 Seasons", date: "Oct 2022 - Ongoing", image: "images/Tales - 3 Seasons.png", description: "Anthology series exploring pivotal moments in characters' lives." },
            { title: "Zen - Grogu and the Dust Bunnies", season: "1 Short", date: "Nov 12, 2022", image: "images/Zen - Grogu and the Dust Bunnies - 1 Short.png", description: "A Studio Ghibli short featuring Grogu interacting with soot sprites." },
            { title: "Young Jedi Adventures", season: "2 Seasons", date: "May 2023 - Ongoing", image: "images/Young Jedi Adventures - 2 Seasons.png", description: "Younglings train in the ways of the Force during the High Republic era." },
            { title: "Fun with Nubs", season: "1 Season", date: "Jun 2024 - Ongoing", image: "images/Fun with Nubs - 1 Season.png", description: "The youngling Nubs gets into mischief while learning about the Force." }
        ];

        const timelineContainer = document.getElementById('timeline-container');
        let watchedState = {};
        let db;
        
        // --- Database and State Management ---
        
        function isIndexedDBAvailable() { return 'indexedDB' in window && window.indexedDB !== null; }
        
        function initDatabase() {
            return new Promise((resolve, reject) => {
                if (!isIndexedDBAvailable()) {
                    console.warn("IndexedDB not available.");
                    reject("IndexedDB not available");
                    return;
                }
                const request = window.indexedDB.open("StarWarsTimelineDB", 1);
                request.onerror = e => { reject("Could not open IndexedDB"); };
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("watchedShows")) db.createObjectStore("watchedShows");
                };
                request.onsuccess = e => {
                    db = e.target.result;
                    db.onerror = event => console.error("Database error:", event.target.errorCode);
                    resolve(db);
                };
            });
        }

        function saveStateToDB() {
            saveStateToLocalStorage(); // Always save to localStorage as a backup
            if (!db) return;
            const transaction = db.transaction(["watchedShows"], "readwrite");
            transaction.objectStore("watchedShows").put({ ...watchedState, _lastSaved: new Date().toISOString() }, "watchedState");
        }

        function loadStateFromDB() {
            if (!db) { loadStateFromLocalStorage(); return; }
            const request = db.transaction(["watchedShows"], "readonly").objectStore("watchedShows").get("watchedState");
            request.onsuccess = e => {
                if (request.result) {
                    const loadedData = request.result;
                    delete loadedData._lastSaved;
                    watchedState = loadedData;
                } else {
                    loadStateFromLocalStorage();
                }
                renderTimeline();
                setupIntersectionObserver();
            };
            request.onerror = e => { loadStateFromLocalStorage(); };
        }

        function loadStateFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('starWarsTimelineWatched');
                watchedState = savedState ? JSON.parse(savedState) : {};
            } catch (e) {
                console.error("Could not load from localStorage:", e);
                watchedState = {};
            }
            renderTimeline();
            setupIntersectionObserver();
        }

        function saveStateToLocalStorage() {
            try {
                localStorage.setItem('starWarsTimelineWatched', JSON.stringify(watchedState));
            } catch (e) {
                console.error("Could not save to localStorage:", e);
            }
        }
        
        // --- UI Rendering ---

        function renderTimeline() {
            timelineContainer.innerHTML = '';
            seriesData.forEach((series, index) => {
                const id = `${series.title}-${series.season}`;
                const isWatched = watchedState[id] || false;
                
                const seriesItem = document.createElement('div');
                seriesItem.className = `timeline-item ${isWatched ? 'watched' : ''}`;
                seriesItem.dataset.id = id;
                seriesItem.dataset.description = series.description;

                seriesItem.innerHTML = `
                    <div class="series-card h-full bg-black bg-opacity-40 backdrop-blur-md rounded-lg shadow-lg border-l-2 border-gray-700 transition-all duration-300 hover:scale-105 hover:shadow-blue-500/20 overflow-hidden flex flex-col">
                        <div class="relative overflow-hidden">
                            <img src="${series.image}" alt="${series.title}" class="series-image w-full h-auto min-h-[80px] max-h-[140px] sm:max-h-[160px] object-cover transition-transform duration-500 hover:scale-110" loading="lazy" onerror="this.style.display='none';">
                        </div>
                        <div class="p-2 flex-grow flex flex-col">
                            <h3 class="series-title text-xs xs:text-sm font-bold text-white leading-tight transition-all duration-300" title="${series.title} - ${series.season}">${series.title} - ${series.season}</h3>
                            <p class="text-2xs xs:text-xs font-medium text-blue-400 truncate mt-1" title="${series.date}">${series.date}</p>
                            <div class="mt-auto pt-2 flex items-center justify-between">
                                <label for="checkbox-${index}" class="text-2xs xs:text-xs text-gray-300 cursor-pointer">Watched</label>
                                <input type="checkbox" id="checkbox-${index}" class="custom-checkbox" ${isWatched ? 'checked' : ''}>
                            </div>
                        </div>
                    </div>
                `;
                timelineContainer.appendChild(seriesItem);
            });
            setupModalListeners(); // Re-attach modal listeners after render
        }
        
        // --- Event Listeners and Observers ---

        function setupEventListeners() {
            timelineContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const timelineItem = e.target.closest('.timeline-item');
                    const id = timelineItem.dataset.id;
                    if (e.target.checked) {
                        timelineItem.classList.add('watched');
                        watchedState[id] = true;
                        showNotification('Progress saved!', 'success');
                    } else {
                        timelineItem.classList.remove('watched');
                        watchedState[id] = false;
                    }
                    saveStateToDB();
                }
            });
        }

        function setupIntersectionObserver() {
            const items = document.querySelectorAll('.timeline-item');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

            items.forEach(item => observer.observe(item));
        }
        
        // --- Feature: Progress Export/Import ---

        function exportProgress() {
            const exportData = {
                appName: "Star Wars Timeline Tracker",
                version: "1.0",
                exportDate: new Date().toISOString(),
                watchedData: watchedState
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `star-wars-progress-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Backup saved successfully!', 'success');
        }

        function importProgress() {
            const fileInput = document.getElementById('import-file');
            fileInput.click();
            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (!imported.watchedData || typeof imported.watchedData !== 'object') {
                            throw new Error('Invalid backup file format.');
                        }
                        watchedState = imported.watchedData;
                        saveStateToDB();
                        renderTimeline();
                        setupIntersectionObserver();
                        showNotification('Backup loaded successfully!', 'success');
                    } catch (err) {
                        showNotification(err.message, 'error');
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsText(file);
            };
        }

        function setupProgressControls() {
            document.getElementById('export-progress').addEventListener('click', exportProgress);
            document.getElementById('import-progress').addEventListener('click', importProgress);
        }
        
        // --- Feature: Image Modal ---
        
        function setupModalListeners() {
            const modal = document.getElementById('imageModal');
            const closeModal = document.getElementById('closeModal');
            
            timelineContainer.querySelectorAll('.series-image').forEach(img => {
                img.addEventListener('click', (e) => {
                    const item = e.target.closest('.timeline-item');
                    document.getElementById('modalImage').src = e.target.src;
                    document.getElementById('modalTitle').textContent = item.dataset.id.replace('-', ' - ');
                    document.getElementById('modalDescription').textContent = item.dataset.description;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                });
            });
            
            const hideModal = () => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            };
            
            closeModal.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
        }
        
        // --- Utilities: Notifications & Connection ---
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('status-notification');
            if (notification.hideTimeout) clearTimeout(notification.hideTimeout);
            
            const icons = { success: '✅', error: '❌', info: 'ℹ️' };
            const colors = { success: 'bg-green-800', error: 'bg-red-800', info: 'bg-blue-800' };
            
            notification.innerHTML = `<span>${icons[type] || ''}</span><span>${message}</span>`;
            notification.className = notification.className.replace(/bg-\w+-800/g, '') + ` ${colors[type] || 'bg-gray-800'}`;
            notification.style.opacity = 1;
            
            notification.hideTimeout = setTimeout(() => { notification.style.opacity = 0; }, 3000);
        }

        function setupConnectionHandlers() {
            const indicator = document.getElementById('offline-indicator');
            const updateStatus = () => { indicator.classList.toggle('hidden', navigator.onLine); };
            updateStatus();
            window.addEventListener('online', () => { showNotification('You are back online', 'success'); updateStatus(); });
            window.addEventListener('offline', () => { showNotification('Offline mode: Progress saved locally', 'info'); updateStatus(); });
        }
        
        // --- App Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            
            initDatabase().then(() => {
                loadStateFromDB();
                showNotification('Tracker loaded successfully', 'success');
            }).catch(error => {
                console.warn("DB init failed, falling back to localStorage.", error);
                loadStateFromLocalStorage();
                showNotification('Using backup storage system', 'info');
            }).finally(() => {
                setupEventListeners();
                setupProgressControls();
                setupConnectionHandlers();
                setInterval(saveStateToDB, 30000); // Auto-save every 30 seconds
                window.addEventListener('beforeunload', saveStateToDB);
            });
        });
    </script>

</body>
</html>